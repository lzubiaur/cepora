#!/usr/bin/env python
# coding=utf-8

# This file is based on gl3w_eng.py from the gl3w library
# hosted at https://github.com/skaslev/gl3w

# Allow Python 2.6+ to use the print() function
from __future__ import print_function

import re
import sys,os

ignored_functions = []
ignored_defines = []
ignored_typdefs = []

# Set the first character of the string to lowercase
downcase = lambda s: s[:1].lower() + s[1:] if s else ''

procs = []      # List of functions
enums = []      # List of defines (will be converted into enum in Lua FFI)
typedefs = []   # List ot typedef

# Split a regular expression into
def func_t(m):
    t = { 'rt': m.group(1),                  # Return type
          'name': downcase(m.group(2)[4:]),  # Strip function name (without the `glfw` prefix)
          'cname': m.group(2),               # Canonical function name (as in the C API)
          'param': m.group(3) }              # Function parameter list (including the brackets)
    if any(f == t['cname'] for f in ignored_functions):
        return
    procs.append(t)

def def_t(m):
    t = { 'name': m.group(1)[5:],            # The `GLFW_` prefix is removed
          'cname': m.group(1),               # Canonical define name
          'value': m.group(2) }
    if any(f == t['cname'] for f in ignored_defines):
        return
    enums.append(t)

def typedef_t(m):
    t = { 'name': m.group(2),
          'type': m.group(1) }
    if any(f in m.group(0) for f in ignored_typdefs):
        return
    typedefs.append(t)

# Regex for functions, defines and typdefs
p = [ [ re.compile(r'GLFWAPI\s(.*)\s(\w+)\s(.*);'), func_t ],
      [ re.compile(r'#define\s*(GLFW_\w+)\s*(-?\w+)'), def_t ],
      [ re.compile(r'typedef(.*)(GL.*);'), typedef_t] ]

# Parse function names, defines and typedefs from glcorearb.h
print('Parsing glfw3.h header...')
with open('lib/glfw/include/GLFW/glfw3.h', 'r') as f:
    for line in f:
        for _p in p:
            m = _p[0].match(line)
            if m:
                _p[1](m)
                continue

# procs.sort()
# enums.sort()
# Remove duplicates
# typedefs = list(set(typedefs))
# typedefs.sort()

def is_numeric(str):
    try:
        int(str, 16)
    except:
        try:
            float(str)
        except:
            return False
    return True

print('Generating build/glfw.h')
with open('build/glfw.h', 'wb') as f:
    f.write('''
/* Autogenerated using gen_glfw_binding.py */

/* GLFW typedef */
''')
    for t in typedefs:
        f.write('typedef {0[type]} {0[name]};\n'.format(t).encode('utf-8'))
    f.write('''
/* GLFW defines */
''')
    for e in enums:
        if not is_numeric(e['value']):
            print('WARNING: {0[name]} is not numeric: {0[value]}'.format(e))
        f.write('{{ {0:<30} {1:<5} }},\n'.format( '"'+e['name']+'",', '(double) '+e['cname']).encode('utf-8'))
    f.write('''
};
/* GLFW functions */
''')

    for p in procs:
        f.write('{0[rt]} {0[name]}{0[param]};\n'.format(p).encode('utf-8'))
